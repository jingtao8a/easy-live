import{b as F,ag as V,o as m,c as y,a as s,O as R,a4 as X,G as Z,H as p,L as z,M as x,P as i,a5 as oe,i as O,u as A,S as Y,I as E,Q as W,C as le,D as ae,K as P,n as D,e as se,j as ie,V as ne,z as re}from"./@vue-JlwsckWB.js";import{_ as K,f as ee,m as T,u as ue,b as de}from"./index-D9sq5B9z.js";import{u as J,a as j}from"./vue-router-hI8gbx6m.js";import{s as pe}from"./vue-draggable-plus-N5Bk0sze.js";import"./pinia-91x-qzso.js";import"./vue-demi-Dq6ymT-8.js";import"./element-plus-BCXmXNOW.js";import"./lodash-es-DpRhkxuT.js";import"./@vueuse-DS8A98-V.js";import"./@element-plus-Dbr4-WMN.js";import"./@popperjs-D9SI2xQl.js";import"./@ctrl-r5W6hzzQ.js";import"./dayjs-Cvt7qOjS.js";import"./artplayer-DYEsUqgO.js";import"./async-validator-DKvM95Vc.js";import"./memoize-one-BdPwpGay.js";import"./normalize-wheel-es-B6fDCfyv.js";import"./@floating-ui-DVIT0l11.js";import"./axios-upsvKRUO.js";import"./vue-cookies-DmNBPvI0.js";import"./@fingerprintjs-BlNouByb.js";import"./tslib-BLN2B0TR.js";import"./vue-cropper-BAfMpYow.js";import"./mitt-DJ65BbbF.js";import"./moment-C5S46NFB.js";const ce={class:"tag-input-panel"},ve={class:"tag-list"},fe={class:"tag-input"},me={class:"info"},ge={__name:"TagInput",props:{modelValue:{type:Array,default:[]}},setup(M){const{proxy:$}=O();J(),j();const _=M,v=e=>{_.modelValue.splice(_.modelValue.indexOf(e),1)},r=F(),w=()=>{if(r.value){if(_.modelValue.length>=10){$.Message.warning("最多只能输入10个标签"),r.value="";return}_.modelValue.push(r.value),r.value=""}};return(e,u)=>{const k=V("el-tag"),d=V("el-input");return m(),y("div",ce,[s("div",ve,[(m(!0),y(R,null,X(M.modelValue,C=>(m(),Z(k,{class:"tag-item",key:C,closable:"","disable-transitions":!1,onClose:S=>v(C)},{default:p(()=>[z(x(C),1)]),_:2},1032,["onClose"]))),128))]),s("div",fe,[i(d,{placeholder:"按回车键Enter创建标签",modelValue:r.value,"onUpdate:modelValue":u[0]||(u[0]=C=>r.value=C),maxlength:15,resize:"none","show-word-limit":"",onKeyup:oe(w,["enter"])},null,8,["modelValue"])]),s("div",me,"最多还可以输入"+x(10-M.modelValue.length)+"个标签",1)])}}},_e=K(ge,[["__scopeId","data-v-14c308e7"]]),ye={class:"uploader-start-panel"},Ve={class:"upload-explain"},Ie={__name:"VideoUploadStart",emits:["addFile"],setup(M,{emit:$}){const _=ee(),{proxy:v}=O();J(),j();const r=$,w=k=>{r("addFile",k)};let e=0;const u=k=>{e==0&&T.emit("startUpload",v.Utils.getFileName(k.name)),e++};return(k,d)=>{const C=V("el-upload"),S=V("el-popover");return m(),y(R,null,[s("div",ye,[i(C,{class:"uploader-start",drag:"","show-file-list":!1,"http-request":w,"before-upload":u,accept:A(v).videoAccept},{default:p(()=>d[0]||(d[0]=[s("div",{class:"upload-handler"},[s("div",{class:"iconfont icon-upload"}),s("div",{class:"info"},"拖拽到此处也可上传"),s("div",{class:"upload-btn"},"上传视频")],-1)])),_:1},8,["accept"])]),s("div",Ve,[i(S,{placement:"top-end",width:400,trigger:"hover"},{reference:p(()=>d[1]||(d[1]=[s("div",{class:"item"},"视频大小",-1)])),default:p(()=>[s("div",null,[s("p",null,"网页端上传的文件大小上限为"+x(A(_).sysSetting.videoSize)+"MB",1),d[2]||(d[2]=s("p",null,"视频内容时长最大3小时",-1)),d[3]||(d[3]=s("p",null,"过长或过大视频建议拆分后使用分p或合集功能进行投稿～",-1))])]),_:1}),i(S,{placement:"top-end",width:420,trigger:"hover"},{reference:p(()=>d[4]||(d[4]=[s("div",{class:"item"},"视频格式",-1)])),default:p(()=>[d[5]||(d[5]=s("div",null,[s("p",null,"推荐上传的格式为：mp4"),s("p",null,"（推荐上传的格式在转码过程更有优势，审核过程更快哦！）"),s("p",null,"其他允许上传的格式：mp4,avi,rmvb,mkv,mov")],-1))]),_:1}),i(S,{placement:"top-end",width:350,trigger:"hover"},{reference:p(()=>d[6]||(d[6]=[s("div",{class:"item"},"视频码率",-1)])),default:p(()=>[d[7]||(d[7]=s("div",null,[s("p",null,"分辨率最大支持 8192*4320"),s("p",null,"推荐视频分辨率：1920*1080 或者 3840*2160")],-1))]),_:1})])],64)}}},we=K(Ie,[["__scopeId","data-v-4ea9e852"]]),he={class:"uploader-start-panel"},ke={key:0},Ce={class:"file-list"},Se={class:"video-p"},Ue={class:"video-p-info"},be={class:"video-info"},Fe={class:"video-title"},xe={class:"upload-info"},Ae={class:"title"},Ne=["onClick"],ze={class:"upload-status"},$e={key:0},Le={class:"op"},Pe={key:0,class:"item percent"},Me=["onClick"],qe=["onClick"],Re=["onClick"],Te={key:0,class:"video-progress"},Be={key:0,class:"add-video-btn"},Ee={__name:"VideoUploader",props:{videoList:{type:Array,default:[]}},setup(M,{expose:$}){const _=ee(),{proxy:v}=O();j();const r={emptyfile:{value:"emptyfile",desc:"文件为空",color:"#F75000",icon:"error"},largefile:{value:"largefile",desc:"文件超过大小"+_.sysSetting.videoSize+"MB",color:"#F75000",icon:"error"},wating:{value:"wating",desc:"等待上传",color:"#e6a23c",icon:"wating"},uploading:{value:"uploading",desc:"上传中",color:"#409eff",icon:"upload"},fail:{value:"fail",desc:"上传失败",color:"#F75000",icon:"error"},success:{value:"success",desc:"上传完成",color:"#67c23a",icon:"success"}},w=v.chunkSize,e=v.maxUploading,u=F([]),k=n=>u.value.find(t=>t.uid==n),d=F(!1);T.on("startUpload",()=>{u.value=[],d.value=!0});const C=n=>{if(n=n.file,u.value.length>=_.sysSetting.videoPCount){v.Message.warning("最多可以添加"+_.sysSetting.videoPCount+"个视频");return}let o=n.name;const t=o.lastIndexOf(".");o=t==-1?o:o.substring(0,t);const f={file:n,uid:n.uid,fileName:o,status:r.wating.value,uploadSize:0,totalSize:n.size,uploadPercent:0,pause:!1,chunkIndex:0,errorMsg:null};if(u.value.push(f),f.totalSize==0){f.status=r.emptyfile.value;return}if(f.totalSize>_.sysSetting.videoSize*1024*1024){f.status=r.largefile.value;return}u.value.filter(b=>b.status==r.uploading.value).length>=e||S(f.uid)},S=async(n,o)=>{const t=k(n);t.status=r.uploading.value,o=o||0;const f=t.file,I=t.totalSize,b=Math.ceil(I/w);if(!t.uploadId){let a=await v.Request({url:v.Api.preUploadVideo,params:{fileName:t.fileName,chunks:b},errorCallback:c=>{t.status=r.fail.value,t.errorMsg=c}});if(!a)return;t.uploadId=a.data}for(let a=o;a<b&&!(t.pause||t.del);a++){let c=a*w,N=c+w>=I?I:c+w,te=f.slice(c,N);if(await v.Request({url:v.Api.uploadVideo,dataType:"file",params:{chunkFile:te,chunkIndex:a,uploadId:t.uploadId},showError:!1,errorCallback:q=>{t.status=r.fail.value,t.errorMsg=q},uploadProgressCallback:q=>{let H=q.loaded;H>I&&(H=I),t.uploadSize=a*w+H,t.uploadPercent=Math.floor(t.uploadSize/I*100)}})==null)break;if(t.chunkIndex=a,a<b-1)continue;t.status=r.success.value,t.uploadProgress=100;const Q=u.value.find(q=>q.status==r.wating.value);Q&&S(Q.uid)}},G=n=>{const o=k(n);o.pause=!0},B=n=>{const o=k(n);o.pause=!1,S(n,o.chunkIndex)},h=async n=>{const o=u.value[n];o.del=!0,u.value.splice(n,1),!o.fileId&&await v.Request({url:v.Api.delUploadVideo,dataType:"file",params:{uploadId:o.uploadId},showError:!1})},l=n=>{const o=u.value[n];o.edit=!0,D(()=>{const t=document.querySelector("#file-input"+o.uid);setTimeout(()=>{t.focus()},100)})},g=n=>{const o=u.value[n];o.edit=!1};return $({getUploadFileList:()=>{let n=0,o=0;for(let f=0,I;I=u.value[f],f<u.value.length;f++){if(I.status===r.fail.value||I.status==r.emptyfile.value){n++;continue}if(I.status===r.uploading.value||I.status===r.wating.value){o++;continue}}return n>0?(v.Message.warning("请删除上传失败的文件"),null):o>0?(v.Message.warning("文件还未上传完成无法提交"),null):u.value.map(f=>({uploadId:f.uploadId,fileId:f.fileId,fileName:f.fileName}))},initUploader:(n,o)=>{d.value=n,u.value.splice(0,u.value.length),o.forEach(t=>{t.transferResult==1?t.status=r.success.value:t.status=r.fail.value,t.uid=t.fileId,t.uploadPercent=100,u.value.push(t)})}}),Y(()=>{T.off("startUpload")}),(n,o)=>{const t=V("el-input"),f=V("el-progress"),I=V("el-button"),b=V("el-upload");return m(),y(R,null,[E(s("div",he,[i(we,{onAddFile:C})],512),[[W,!d.value]]),d.value?(m(),y("div",ke,[E((m(),y("div",Ce,[(m(!0),y(R,null,X(u.value,(a,c)=>(m(),y("div",{class:"file-item",key:c},[s("div",Se,[o[0]||(o[0]=s("div",{class:"iconfont icon-video"},null,-1)),s("div",Ue,"P"+x(c+1),1)]),s("div",be,[s("div",Fe,[s("div",xe,[s("div",Ae,[E(i(t,{id:"file-input"+a.uid,modelValue:a.fileName,"onUpdate:modelValue":N=>a.fileName=N,size:"small",onBlur:N=>g(c)},null,8,["id","modelValue","onUpdate:modelValue","onBlur"]),[[W,a.edit]]),E(s("div",{class:"title-show",onClick:N=>l(c)},x(a.fileName),9,Ne),[[W,!a.edit]])]),s("div",ze,[a.status=="uploading"?(m(),y("span",$e," 已经上传："+x(A(v).Utils.size2Str(a.uploadSize))+"/"+x(A(v).Utils.size2Str(a.totalSize)),1)):(m(),y("span",{key:1,class:le(["iconfont","icon-"+r[a.status].icon]),style:ae({color:r[a.status].color})},x(r[a.status].desc),7))])]),s("div",Le,[a.status=="uploading"?(m(),y("div",Pe,x(a.uploadPercent)+"% ",1)):P("",!0),a.status=="uploading"?(m(),y(R,{key:1},[a.pause?(m(),y("div",{key:0,class:"item iconfont icon-play3",onClick:N=>B(a.uid)},null,8,Me)):(m(),y("div",{key:1,class:"item iconfont icon-pause",onClick:N=>G(a.uid)},null,8,qe))],64)):P("",!0),s("div",{class:"item iconfont icon-del",onClick:N=>h(c)},null,8,Re)])]),a.status=="uploading"||a.status=="success"?(m(),y("div",Te,[i(f,{percentage:a.uploadPercent,"show-text":!1,"stroke-width":3,status:a.status=="uploading"?"":"success"},null,8,["percentage","status"])])):P("",!0)])]))),128))])),[[A(pe),[u.value,{animation:150,handle:".video-p"}]]]),u.value.length<A(_).sysSetting.videoPCount?(m(),y("div",Be,[i(b,{multiple:"","show-file-list":!1,"http-request":C,accept:A(v).videoAccept},{default:p(()=>[i(I,{type:"primary"},{default:p(()=>o[1]||(o[1]=[z("添加分P")])),_:1})]),_:1},8,["accept"])])):P("",!0)])):P("",!0)],64)}}},De=K(Ee,[["__scopeId","data-v-28796983"]]),Oe={class:"upload-video-panel"},Ke={key:0,class:"video-form"},je={__name:"Post",setup(M){const $=ue(),{proxy:_}=O(),v=J(),r=j(),w=F(!1);T.on("startUpload",h=>{w.value=!0,D(()=>{u.value.resetFields(),e.value={},e.value.tags=[],e.value.videoName=h})});const e=F({tags:[]}),u=F(),k={videoCover:[{required:!0,message:"封面不能为空"}],videoName:[{required:!0,message:"标题不能为空"}],postType:[{required:!0,message:"类型不能为空"}],originInfo:[{required:!0,message:"转载说明不能为空"}],categoryArray:[{required:!0,message:"分区不能为空"}],tags:[{required:!0,message:"标签不能为空"}]};re("cutImageCallback",({coverImage:h})=>{e.value.videoCover=h});const d=F();F([]);const C=()=>{const h=d.value.getUploadFileList();h&&u.value.validate(async l=>{if(!l)return;let g={uploadFileList:JSON.stringify(h)};if(Object.assign(g,e.value),g.pCategoryId=g.categoryArray[0],g.categoryArray.length>1&&(g.categoryId=g.categoryArray[1]),delete g.categoryArray,g.interactionArray&&(g.interaction=g.interactionArray.join(","),delete g.interactionArray),g.videoCover instanceof File){const L=await de(g.videoCover);if(!L)return;g.videoCover=L}await _.Request({url:_.Api.postVideo,showLoading:!0,params:g})&&(_.Message.success("发布成功"),r.push("/ucenter/video"))})},S=F(),G=async()=>{if(D(()=>{d.value.initUploader(w.value,[])}),S.value){let h=await _.Request({url:_.Api.getVideoByVideoId,params:{videoId:S.value}});if(!h)return;e.value=h.data.videoInfo,e.value.tags=e.value.tags.split(","),e.value.categoryArray=[],e.value.pCategoryId&&e.value.categoryArray.push(e.value.pCategoryId),e.value.categoryId&&e.value.categoryArray.push(e.value.pCategoryId),e.value.interactionArray=e.value.interaction?e.value.interaction.split(","):[],D(()=>{d.value.initUploader(w.value,h.data.videoInfoFileList)})}};se(()=>v.query.videoId,(h,l)=>{h?w.value=!0:w.value=!1,S.value=h,G()},{immediate:!0,deep:!0});const B=()=>{};return ie(()=>{window.addEventListener("beforeunload",B)}),Y(()=>{T.off("startUpload"),window.removeEventListener("beforeunload",B)}),(h,l)=>{const g=V("ImageCoverSelect"),U=V("el-form-item"),L=V("el-input"),n=V("el-radio"),o=V("el-radio-group"),t=V("el-cascader"),f=V("el-checkbox"),I=V("el-checkbox-group"),b=V("el-button"),a=V("el-form");return m(),y("div",Oe,[i(De,{ref_key:"videoUploaderRef",ref:d},null,512),w.value?(m(),y("div",Ke,[i(a,{model:e.value,rules:k,ref_key:"formDataRef",ref:u,"label-width":"70px",onSubmit:l[8]||(l[8]=ne(()=>{},["prevent"]))},{default:p(()=>[i(U,{label:"封面",prop:"videoCover"},{default:p(()=>[i(g,{coverWidth:200,cutWidth:680,scale:.6,coverImage:e.value.videoCover},null,8,["coverImage"])]),_:1}),i(U,{label:"标题",prop:"videoName"},{default:p(()=>[i(L,{clearable:"",placeholder:"请输入标题",modelValue:e.value.videoName,"onUpdate:modelValue":l[0]||(l[0]=c=>e.value.videoName=c),maxlength:"100","show-word-limit":""},null,8,["modelValue"])]),_:1}),i(U,{label:"类型",prop:"postType"},{default:p(()=>[i(o,{modelValue:e.value.postType,"onUpdate:modelValue":l[1]||(l[1]=c=>e.value.postType=c)},{default:p(()=>[i(n,{value:0},{default:p(()=>l[9]||(l[9]=[z("自制")])),_:1}),i(n,{value:1},{default:p(()=>l[10]||(l[10]=[z("转载")])),_:1})]),_:1},8,["modelValue"])]),_:1}),e.value.postType==1?(m(),Z(U,{key:0,label:"",prop:"originInfo"},{default:p(()=>[i(L,{clearable:"",placeholder:"转载视频请注明来源、时间、地点(例：转自https://www.xxxx.com/yyyy)，注明来源会更快地通过审核哦",modelValue:e.value.originInfo,"onUpdate:modelValue":l[2]||(l[2]=c=>e.value.originInfo=c),maxlength:"200","show-word-limit":""},null,8,["modelValue"])]),_:1})):P("",!0),i(U,{label:"标签",prop:"tags"},{default:p(()=>[i(_e,{modelValue:e.value.tags,"onUpdate:modelValue":l[3]||(l[3]=c=>e.value.tags=c)},null,8,["modelValue"])]),_:1}),i(U,{label:"分区",prop:"categoryArray"},{default:p(()=>[i(t,{modelValue:e.value.categoryArray,"onUpdate:modelValue":l[4]||(l[4]=c=>e.value.categoryArray=c),options:A($).categoryList,props:{value:"categoryId",label:"categoryName"}},null,8,["modelValue","options"])]),_:1}),i(U,{label:"简介",prop:"introduction"},{default:p(()=>[i(L,{clearable:"",placeholder:"填写更全面的相关信息，让更多的人能找到你的视频吧(: 	",type:"textarea",rows:5,maxlength:2e3,resize:"none","show-word-limit":"",modelValue:e.value.introduction,"onUpdate:modelValue":l[5]||(l[5]=c=>e.value.introduction=c)},null,8,["modelValue"])]),_:1}),i(U,{label:"互动设置",prop:"introduction"},{default:p(()=>[i(I,{modelValue:e.value.interactionArray,"onUpdate:modelValue":l[6]||(l[6]=c=>e.value.interactionArray=c)},{default:p(()=>[i(f,{value:"0"},{default:p(()=>l[11]||(l[11]=[z("关闭弹幕")])),_:1}),i(f,{value:"1"},{default:p(()=>l[12]||(l[12]=[z("关闭评论")])),_:1})]),_:1},8,["modelValue"])]),_:1}),i(U,{label:""},{default:p(()=>[i(b,{type:"primary",onClick:C},{default:p(()=>l[13]||(l[13]=[z("立即投稿")])),_:1}),i(b,{onClick:l[7]||(l[7]=c=>A(r).push("/ucenter/video"))},{default:p(()=>l[14]||(l[14]=[z("取消")])),_:1})]),_:1})]),_:1},8,["model"])])):P("",!0)])}}},yt=K(je,[["__scopeId","data-v-9cf4a752"]]);export{yt as default};
